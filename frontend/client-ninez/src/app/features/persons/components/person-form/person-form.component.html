<div class="form-wrapper">
	<!-- Header -->
	<div class="form-header">
		<button mat-icon-button class="back-button" (click)="goBack()" aria-label="Volver">
			<mat-icon>arrow_back</mat-icon>
		</button>
		<div class="header-content">
			<div class="title-section">
				<mat-icon class="title-icon">
					{{ isCreateMode ? 'person_add' : isEditMode ? 'edit' : 'visibility' }}
				</mat-icon>
				<div>
					<h1 class="title">{{ formTitle }}</h1>
					<p class="subtitle">
						{{
						isCreateMode
						? 'Complete los datos de la nueva persona'
						: isEditMode
						? 'Modifique los datos necesarios'
						: 'Información de la persona'
						}}
					</p>
				</div>
			</div>
			@if(!isViewMode) {
			<mat-chip class="mode-chip" *ngIf="!isViewMode" [highlighted]="true">
				<mat-icon>{{ isCreateMode ? 'add_circle' : 'edit_note' }}</mat-icon>
				{{ isCreateMode ? 'Modo Creación' : 'Modo Edición' }}
			</mat-chip>
			}
		</div>
	</div>



	<!-- Loading State -->
	@if(loading()) {
	<div class="loading-container">
		<mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
		<p>Cargando información...</p>
	</div>
	} @else {
	<!-- Form Content -->
	<div class="form-content">
		<!-- Tabs para Datos Personales y Familia -->

		<mat-tab-group class="form-tabs" [dynamicHeight]="true">
			<!-- Tab 1: Datos Generales -->
			<mat-tab>
				<ng-template mat-tab-label>
					<mat-icon class="tab-icon">person</mat-icon>
					Datos Generales
				</ng-template>

				<div class="tab-content-general">
					<!-- Formulario de Datos Personales -->
					<form [formGroup]="personForm" (ngSubmit)="onSubmit()" class="tab-content">
						<!-- Datos Personales Card -->
						<mat-card class="form-section">
							<mat-card-header>
								<mat-card-title class="section-title">
									<mat-icon class="section-icon">badge</mat-icon>
									Información General
								</mat-card-title>
							</mat-card-header>
							<mat-card-content>
								<div class="form-grid">
									<!-- DNI -->
									<mat-form-field appearance="outline" class="form-field">
										<mat-label>DNI</mat-label>
										<input matInput formControlName="dni" placeholder="12345678" type="text"
											maxlength="8" [readonly]="isEditMode || isViewMode" />
										<mat-icon matPrefix class="field-icon">fingerprint</mat-icon>
										@if(personForm.get('dni')?.hasError('required')) {
										<mat-error>El DNI es requerido</mat-error>
										} @if(personForm.get('dni')?.hasError('pattern')) {
										<mat-error>DNI inválido (7-8 dígitos)</mat-error>
										}
									</mat-form-field>

									<!-- Nombre -->
									<mat-form-field appearance="outline" class="form-field">
										<mat-label>Nombre</mat-label>
										<input matInput formControlName="nombre" placeholder="Juan"
											[readonly]="isViewMode" />
										<mat-icon matPrefix class="field-icon">person</mat-icon>
										@if(personForm.get('nombre')?.hasError('required')) {
										<mat-error>El nombre es requerido</mat-error>
										} @if(personForm.get('nombre')?.hasError('minlength')) {
										<mat-error>Mínimo 2 caracteres</mat-error>
										}
									</mat-form-field>

									<!-- Apellido -->
									<mat-form-field appearance="outline" class="form-field">
										<mat-label>Apellido</mat-label>
										<input matInput formControlName="apellido" placeholder="Pérez"
											[readonly]="isViewMode" />
										<mat-icon matPrefix class="field-icon">person_outline</mat-icon>
										@if(personForm.get('apellido')?.hasError('required')) {
										<mat-error>El apellido es requerido</mat-error>
										} @if(personForm.get('apellido')?.hasError('minlength')) {
										<mat-error>Mínimo 2 caracteres</mat-error>
										}
									</mat-form-field>

									<!-- Fecha de Nacimiento -->
									<mat-form-field appearance="outline" class="form-field">
										<mat-label>Fecha de Nacimiento</mat-label>
										<input matInput g formControlName="fecha_nacimiento" placeholder="DD/MM/YYYY"
											[readonly]="isViewMode" />
										<mat-icon matPrefix class="field-icon">cake</mat-icon>
										@if(!isViewMode) {
										<mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
										}
										<mat-datepicker #picker></mat-datepicker>
										@if(personForm.get('fecha_nacimiento')?.hasError('required')) {
										<mat-error>La fecha de nacimiento es requerida</mat-error>
										}
									</mat-form-field>

									<!-- Género -->
									<mat-form-field appearance="outline" class="form-field">
										<mat-label>Género</mat-label>
										@if(isViewMode) {
										<input matInput formControlName="genero" readonly />
										} @else {
										<mat-select formControlName="genero" placeholder="Seleccione"
											*ngIf="!isViewMode">
											<mat-option *ngFor="let genero of generos" [value]="genero.nombre">
												{{ genero.nombre }}
											</mat-option>
										</mat-select>
										}
										<mat-icon matPrefix class="field-icon">wc</mat-icon>
										@if(personForm.get('genero')?.hasError('required')) {
										<mat-error>El género es requerido</mat-error>
										}
									</mat-form-field>

									<!-- Nacionalidad -->
									<mat-form-field appearance="outline" class="form-field">
										<mat-label>Nacionalidad</mat-label>
										@if(isViewMode) {
										<input matInput formControlName="nacionalidad" readonly />
										} @else {
										<mat-select formControlName="nacionalidad" placeholder="Seleccione">
											@for(nacionalidad of nacionalidades; track nacionalidad.nombre) {
											<mat-option [value]="nacionalidad.nombre">
												{{ nacionalidad.nombre }}
											</mat-option>
											}
										</mat-select>
										}
										<mat-icon matPrefix class="field-icon">flag</mat-icon>
										@if(personForm.get('nacionalidad')?.hasError('required')) {
										<mat-error>La nacionalidad es requerida</mat-error>
										}
									</mat-form-field>
								</div>
							</mat-card-content>
						</mat-card>

						<!-- Action Buttons -->
						<div class="form-actions">
							@if(!isViewMode) {
							<button mat-raised-button color="primary" type="submit" class="submit-button"
								[disabled]="personForm.invalid || loading()">
								<mat-icon>{{ isCreateMode ? 'add' : 'save' }}</mat-icon>
								{{ submitButtonText }}
							</button>
							}
							<button mat-stroked-button type="button" class="cancel-button" (click)="onCancel()">
								<mat-icon>{{ isViewMode ? 'arrow_back' : 'close' }}</mat-icon>
								{{ isViewMode ? 'Volver' : 'Cancelar' }}
							</button>
						</div>
					</form>

					<!-- Domicilio Section (Moved here) -->
					@if(personDni()) {
					<mat-divider class="section-divider"></mat-divider>
					<div class="tab-content">
						<div class="family-tab-header">
							<div class="header-info">
								<mat-icon class="header-icon">home</mat-icon>
								<div>
									<h2 class="family-title">Domicilios</h2>
									<p class="family-subtitle">
										{{ domicilios().length > 0 ? 'Domicilios registrados' : 'No hay domicilios
										registrados' }}
									</p>
								</div>
							</div>
							@if(!isViewMode) {
							<button mat-raised-button color="primary" class="add-family-button"
								(click)="onAddDomicilio()">
								<mat-icon>add_location_alt</mat-icon>
								Agregar Domicilio
							</button>
							}
						</div>

						@if(loadingDomicilios()) {
						<div class="loading-container">
							<mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
							<p>Cargando domicilios...</p>
						</div>
						}

						@if(!loadingDomicilios()) {
						<app-address-list [domicilios]="domicilios()" [isViewMode]="isViewMode"
							(deleteAddress)="onDeleteDomicilio($event)"></app-address-list>
						}

						<!-- Contactos Section -->
						<mat-divider class="section-divider" style="margin: 24px 0;"></mat-divider>
						<div class="family-tab-header">
							<div class="header-info">
								<mat-icon class="header-icon">contact_phone</mat-icon>
								<div>
									<h2 class="family-title">Contactos</h2>
									<p class="family-subtitle">
										{{ contacts().length > 0 ? 'Teléfonos de contacto registrados' : 'No hay
										contactos registrados' }}
									</p>
								</div>
							</div>
							@if(!isViewMode) {
							<button mat-raised-button color="primary" class="add-family-button"
								(click)="onAddContact()">
								<mat-icon>add_call</mat-icon>
								Agregar Contacto
							</button>
							}
						</div>
						<app-contact-list [contacts]="contacts()" [isViewMode]="isViewMode"
							(deleteContact)="onDeleteContact($any($event))"></app-contact-list>
					</div>
					}
				</div>
			</mat-tab>

			<!-- Tab 2: Familia y Comunidad -->
			@if(personDni()) {
			<mat-tab>
				<ng-template mat-tab-label>
					<mat-icon class="tab-icon">groups</mat-icon>
					Familia y Comunidad @if(familyMembers().length > 0) {
					<span class="family-count">({{ familyMembers().length }})</span>
					}
				</ng-template>

				<div class="tab-content">
					<!-- Header de la pestaña Familia -->
					<div class="family-tab-header">
						<div class="header-info">
							<mat-icon class="header-icon">groups</mat-icon>
							<div>
								<h2 class="family-title">Grupo Familiar y Comunitario</h2>
								<p class="family-subtitle">
									{{ familyMembers().length > 0 ? 'Familiares registrados' : 'No hay familiares
									registrados' }}
								</p>
							</div>
						</div>
						@if(!isViewMode) {
						<button mat-raised-button color="primary" class="add-family-button"
							(click)="onAddFamilyMember()">
							<mat-icon>person_add</mat-icon>
							Agregar Familiar
						</button>
						}
					</div>

					<!-- Loading State -->
					@if(loadingFamily()) {
					<div class="loading-container">
						<mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
						<p>Cargando familia...</p>
					</div>
					}

					<!-- Family Tree Component -->
					@if(!loadingFamily()) {
					<app-family-tree [familyMembers]="familyMembers()" [isViewMode]="isViewMode"
						(editMember)="onEditFamilyMember($event)" (deleteMember)="onDeleteFamilyMember($event)"
						(viewMember)="onViewFamilyMember($event)"></app-family-tree>
					}
				</div>

				<!-- SUGERERENCIAS -->

				<mat-divider class="section-divider"></mat-divider>

				<div class="suggested-family-section">
					<div class="family-tab-header suggested-header">
						<div class="header-info">
							<mat-icon class="header-icon">person_search</mat-icon>
							<div>
								<h2 class="family-title">Sugerencias de Familia</h2>
								<p class="family-subtitle">Personas posiblemente relacionadas</p>
							</div>
						</div>
					</div>

					<div class="suggested-list">
						<app-suggested-person-card *ngFor="let suggestion of suggestedFamily()" [person]="suggestion"
							(add)="addSuggestedFamily($event)" (view)="onViewSuggestedPerson($event)" />
					</div>
				</div>
			</mat-tab>
			}

			<!-- Tab 3: Salud y Educación -->
			<mat-tab label="Salud y Educación">
				<div class="empty-state-placeholder">
					<mat-icon>local_hospital</mat-icon>
					<p>Sección en construcción</p>
				</div>
			</mat-tab>

			<!-- Tab 4: Datos Importantes -->
			<mat-tab label="Datos Importantes">
				<div class="empty-state-placeholder">
					<mat-icon>priority_high</mat-icon>
					<p>Sección en construcción</p>
				</div>
			</mat-tab>

			<!-- Tab 5: Articulaciones -->
			<mat-tab label="Articulaciones">
				<div class="empty-state-placeholder">
					<mat-icon>hub</mat-icon>
					<p>Sección en construcción</p>
				</div>
			</mat-tab>

			<!-- Tab 6: Condiciones de Vida -->
			<mat-tab label="Condiciones de Vida">
				<div class="empty-state-placeholder">
					<mat-icon>home_work</mat-icon>
					<p>Sección en construcción</p>
				</div>
			</mat-tab>

			<!-- Tab 7: Servicio Local (Restricted) -->
			@if(canViewServicioLocal) {
			<mat-tab label="Servicio Local">
				<div class="empty-state-placeholder">
					<mat-icon>security</mat-icon>
					<p>Área restringida a Servicio Local y Protección</p>
				</div>
			</mat-tab>
			}

		</mat-tab-group>
	</div>

	}
</div>