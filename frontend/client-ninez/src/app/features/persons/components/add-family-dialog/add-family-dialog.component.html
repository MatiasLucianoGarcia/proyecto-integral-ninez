<div class="dialog-header">
	<div class="header-content">
		<mat-icon class="header-icon">{{ isEditMode ? 'edit' : 'person_add' }}</mat-icon>
		<h2 class="dialog-title">{{ dialogTitle }}</h2>
	</div>
	<button mat-icon-button (click)="onCancel()" class="close-button">
		<mat-icon>close</mat-icon>
	</button>
</div>

<mat-dialog-content class="dialog-content">
	<form [formGroup]="familyForm" class="family-form">
		<!-- Búsqueda de Persona por DNI -->
		<div class="search-section">
			<mat-form-field appearance="outline" class="full-width">
				<mat-label>DNI del Familiar</mat-label>
				<input matInput formControlName="dni" placeholder="Ingrese DNI (7-8 dígitos)" type="text" maxlength="8" [readonly]="isEditMode" />
				<mat-icon matPrefix>fingerprint</mat-icon>
				@if(searchingPerson()) {
				<mat-spinner matSuffix diameter="20"></mat-spinner>
				} @if(familyForm.get('dni')?.hasError('required')) {
				<mat-error>El DNI es requerido</mat-error>
				} @if(familyForm.get('dni')?.hasError('pattern')) {
				<mat-error>DNI inválido (7-8 dígitos)</mat-error>
				}
			</mat-form-field>

			<!-- Información de persona encontrada -->
			@if(selectedPerson()) {
			<div class="person-found">
				<div class="found-icon-wrapper">
					<mat-icon class="found-icon">check_circle</mat-icon>
				</div>
				<div class="found-info">
					<p class="found-name">{{ selectedPerson()?.nombre }} {{ selectedPerson()?.apellido }}</p>
					<p class="found-details">DNI: {{ selectedPerson()?.dni }} | Género: {{ selectedPerson()?.genero?.nombre }}</p>
				</div>
			</div>
			} @else if(!searchingPerson() && familyForm.get('dni')?.value?.length >= 7) {
			<div class="person-not-found">
				<mat-icon class="not-found-icon">person_off</mat-icon>
				<p class="not-found-text">No se encontró persona con ese DNI</p>
			</div>
			}
		</div>

		<!-- Tipo de Relación -->
		<mat-form-field appearance="outline" class="full-width">
			<mat-label>Tipo de Relación</mat-label>
			<mat-select formControlName="id_parentezco" placeholder="Seleccione el parentesco">
				@for(parentezco of parentezcoTypes(); track parentezco.id) {
				<mat-option [value]="parentezco.id">
					{{ parentezco.descripcion }}
				</mat-option>
				}
			</mat-select>
			<mat-icon matPrefix>family_restroom</mat-icon>
			@if(familyForm.get('id_parentezco')?.hasError('required')) {
			<mat-error>El tipo de relación es requerido</mat-error>
			}
		</mat-form-field>

		<!-- Observaciones -->
		<mat-form-field appearance="outline" class="full-width">
			<mat-label>Observaciones (Opcional)</mat-label>
			<textarea matInput formControlName="observaciones" placeholder="Información adicional sobre la relación" rows="3"></textarea>
			<mat-icon matPrefix>note</mat-icon>
		</mat-form-field>
	</form>
</mat-dialog-content>

<mat-dialog-actions class="dialog-actions">
	<button mat-stroked-button type="button" (click)="onCancel()" class="cancel-button">
		<mat-icon>close</mat-icon>
		Cancelar
	</button>
	<button
		mat-raised-button
		color="primary"
		type="submit"
		(click)="onSubmit()"
		class="submit-button"
		[disabled]="familyForm.invalid || !selectedPerson()"
	>
		<mat-icon>{{ isEditMode ? 'save' : 'add' }}</mat-icon>
		{{ isEditMode ? 'Guardar Cambios' : 'Agregar Familiar' }}
	</button>
</mat-dialog-actions>
